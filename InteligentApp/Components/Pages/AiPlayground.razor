@page "/ai-playground"


<h3>AiPlayground - Zapytaj AI o co chesz, dla odpowiedzi wygenrujemy sentyment oraz kluczowe frazy</h3>
<br/>

<p>Wpisz poniżej prompt (pytanie lub polecenie), a następnie kliknij przycisk, aby wygenerować odpowiedź od modelu GPT</p>

<div class="mb-3">
    <label for="promptInput" class="form-label">Prompt:</label>
    <textarea id="promptInput" class="form-control" rows="3" @bind="_userPrompt"></textarea>
</div>

<button class="btn btn-primary" @onclick="GenerateTextAsync">Generuj tekst</button>

@if (_isLoading)
{
    <p class="mt-3">Proszę poczekać, generuję odpowiedź...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger mt-3">@_error</div>
}
else if (_showResult && !string.IsNullOrWhiteSpace(_generatedText))
{
    <div>
        <h4>Wynik:</h4>
        <p>@_generatedText</p>
    </div>

    <div>
        <h4>Wynik analizy:</h4>
        <p><strong>Sentyment:</strong> @_sentimentResult</p>
        <p><strong>Kluczowe frazy:</strong></p>
        <ul>
            @foreach (var phrase in _keyPhrases)
            {
                <li>@phrase</li>
            }
        </ul>
    </div>
}

@code {
    /// <summary>
    /// User's prompt input.
    /// </summary>
    private string _userPrompt = string.Empty;

    /// <summary>
    /// Generated text from GPT.
    /// </summary>
    private string _generatedText = string.Empty;

    /// <summary>
    /// Indicates if the response is being generated.
    /// </summary>
    private bool _isLoading = false;

     private bool _showResult = false;

    private string _sentimentResult = string.Empty;

    private List<string> _keyPhrases = new();

    private string? _error = null;


    [Inject]
    public IOpenAiService OpenAiService { get; set; } = default!;

    [Inject]
    public IAzureLanguageService AzureLanguageService { get; set; } = default!;

    /// <summary>
    /// Generates text using GPT-4 based on the user's prompt.
    /// </summary>
    private async Task GenerateTextAsync()
    {
        if (string.IsNullOrWhiteSpace(_userPrompt))
        {
            _error = "Proszę wpisać prompt.";
            _showResult = false;
            return;
        }

        _isLoading = true;
        _showResult = false;
        _error = null;

        _generatedText = string.Empty;
        _sentimentResult = string.Empty;
        _keyPhrases.Clear();

        try
        {
            _generatedText = await OpenAiService.GenerateTextAsync(_userPrompt);

            if (string.IsNullOrWhiteSpace(_generatedText))
                throw new InvalidOperationException("AI nie zwróciło odpowiedzi.");

            var sentimentDoc = await AzureLanguageService.AnalyzeTextApiAsync(_generatedText, "SentimentAnalysis");
            var keyPhrasesDoc = await AzureLanguageService.AnalyzeTextApiAsync(_generatedText, "KeyPhraseExtraction");

            _sentimentResult = sentimentDoc.Sentiment ?? "Brak wyniku sentymentu.";
            _keyPhrases = keyPhrasesDoc.KeyPhrases ?? new List<string>();

            _showResult = true;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            _showResult = false;
        }
        finally
        {
            _isLoading = false;
        }
    }

}
